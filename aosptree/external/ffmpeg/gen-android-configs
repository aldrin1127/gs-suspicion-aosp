#!/bin/bash
#
# Generate configurations for various FFMPEG targets
TARGETS="aarch64 x86_64"
TOOLS_BASE="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"

BASE_CONFIG=" \
  --disable-autodetect       \
  --disable-debug            \
  --disable-decoders         \
  --disable-demuxers         \
  --disable-devices          \
  --disable-doc              \
  --disable-programs         \
  --disable-random           \
  --disable-rpath            \
  --disable-shared           \
  --disable-symver           \
  --enable-gpl               \
  --enable-version3          \
  --enable-nonfree           \
  --enable-dwt               \
  --enable-extra-warnings    \
  --enable-faan              \
  --enable-fast-unaligned    \
  --enable-ftrapv            \
  --enable-hardcoded-tables  \
  --enable-gray              \
  --enable-iamf              \
  --enable-jni               \
  --enable-lsp               \
  --enable-lto               \
  --enable-memory-poisoning  \
  --enable-network           \
  --enable-ossfuzz           \
  --enable-optimizations     \
  --enable-linux-perf        \
  --enable-lto               \
  --enable-pic               \
  --enable-pixelutils        \
  --enable-pthreads          \
  --enable-runtime-cpudetect \
  --enable-safe-bitstream-reader \
  --enable-shared            \
  --enable-stripping         \
  --enable-swscale-alpha     \
  --enable-thumb
"
BASE_CONFIG+=" \
  --disable-appkit          \
  --disable-avfoundation    \
  --disable-coreimage       \
  --disable-metal           \
  --disable-pocketsphinx    \
  --disable-schannel        \
  --disable-securetransport \
  --disable-xlib            \
  --enable-alsa        \
  --enable-avisynth    \
  --enable-bzlib       \
  --enable-chromaprint \
  --enable-crystalhd   \
  --enable-decklink    \
  --enable-frei0r      \
  --enable-gcrypt      \
  --enable-gmp         \
  --enable-gnutls      \
  --enable-harfbuzz    \
  --enable-iconv       \
  --enable-ladspa      \
  --enable-lcms2       \
  --enable-lv2         \
  --enable-lzma        \
  --enable-mediacodec  \
  --enable-openal      \
  --enable-opencl      \
  --enable-opengl      \
  --enable-openssl     \
  --enable-sdl2        \
  --enable-sndio       \
  --enable-vapoursynth \
  --enable-zlib        \
"
BASE_CONFIG+=" \
  --disable-audiotoolbox \
  --disable-videotoolbox \
  --enable-amf      \
  --enable-libdrm   \
  --enable-libmfx   \
  --enable-libvpl   \
  --enable-mmal     \
  --enable-omx      \
  --enable-rkmpp    \
  --enable-v4l2-m2m \
  --enable-vaapi    \
  --enable-vulkan
"
BASE_CONFIG+=" \
  --enable-cross-compile      \
  --target-os=linux           \
  --cc=${TOOLS_BASE}/clang    \
  --cxx=${TOOLS_BASE}/clang++ \
  --nm=${TOOLS_BASE}/llvm-nm  \
  --strip=${TOOLS_BASE}/llvm-strip \
  --ar=${TOOLS_BASE}/llvm-ar  \
  --ld=${TOOLS_BASE}/ld.lld   \
  --ranlib=${TOOLS_BASE}/llvm-ranlib \
  --windres=${TOOLS_BASE}/llvm-windres \
  --x86asmexe=${TOOLS_BASE}/yasm \
  --extra-cflags=\"-s -static --static\" \
  --extra-cxxflags=\"-s -static --static\" \
  --extra-ldflags=\"-s -static --static\"
"

OPTS_aarch64=" \
  --arch=aarch64 \
  --cpu=armv9-a  \
  --cross-prefix=${TOOLS_BASE}/aarch64/aarch64-linux-android-4.9/bin/aarch64-linux-android-
"
OPTS_x86_64=" \
  --arch=x86   \
  --cpu=x86-64 \
  --cross-prefix=${TOOLS_BASE}/x86_64/x86_64-linux-android-4.9/bin/x86_64-linux-android=
"

for TARGET in $TARGETS; do
  ARCH_OPTS=OPTS_`echo $TARGET`
  ./configure ${!ARCH_OPTS} $BASE_CONFIG
  mkdir -p android/include
  mv ffbuild/config.mak android/config-${TARGET}.mak
  cat config.h | sed -e "s/^#define \(ARCH_.*\|HAVE_.*\) \(.*\)/#ifdef \1\n#undef \1\n#endif\n#define \1 \2/g" > android/include/config-${TARGET}.h
done

GENERATED_FILES=" \
    config_components.h \
    libavutil/avconfig.h \
    libavcodec/codec_list.c \
    libavcodec/parser_list.c \
    libavcodec/bsf_list.c \
    libavformat/demuxer_list.c \
    libavformat/muxer_list.c \
    libavformat/protocol_list.c \
"
for GEN in $GENERATED_FILES; do
    mkdir -p android/include/`dirname $GEN`
    mv $GEN android/include/$GEN
done

cat > android/include/libavutil/ffversion.h <<EOF
#ifndef FFVERSION_H
#define FFVERSION_H
#define FFMPEG_VERSION "`cat VERSION` (Gamestar Suspicion)"
#endif /* FFVERSION_H */
EOF
